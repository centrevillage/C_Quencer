#include "dac.h"
#include "input.h"
#include "sequencer.h"
#include "wavetable.h"

// ピッチを1 tick = (62.5us) あたりのtable index移動量として表現 (精度を上げるため100倍してテーブルに保持)
// C1 - B8
static float pitch_to_tableidx_x100[120] = {
  0.1308127826502993,
  0.13859131548843603,
  0.1468323839587038,
  0.15556349186104046,
  0.16481377845643497,
  0.17461411571650196,
  0.1849972113558172,
  0.19599771799087465,
  0.20765234878997257,
  0.22,
  0.23308188075904496,
  0.24694165062806206,
  0.2616255653005986,
  0.27718263097687207,
  0.2936647679174076,
  0.3111269837220809,
  0.32962755691286993,
  0.3492282314330039,
  0.3699944227116344,
  0.3919954359817493,
  0.41530469757994515,
  0.44,
  0.4661637615180899,
  0.493883301256124,
  0.5232511306011972,
  0.5543652619537441,
  0.5873295358348151,
  0.6222539674441618,
  0.65925511382574,
  0.6984564628660078,
  0.7399888454232688,
  0.7839908719634987,
  0.8306093951598903,
  0.88,
  0.9323275230361798,
  0.987766602512248,
  1.0465022612023944,
  1.1087305239074883,
  1.1746590716696301,
  1.2445079348883237,
  1.31851022765148,
  1.3969129257320156,
  1.4799776908465376,
  1.5679817439269974,
  1.6612187903197806,
  1.76,
  1.8646550460723592,
  1.975533205024497,
  2.093004522404789,
  2.2174610478149765,
  2.349318143339261,
  2.4890158697766473,
  2.637020455302959,
  2.7938258514640317,
  2.9599553816930753,
  3.135963487853994,
  3.3224375806395616,
  3.52,
  3.7293100921447184,
  3.951066410048994,
  4.186009044809578,
  4.434922095629953,
  4.698636286678522,
  4.978031739553295,
  5.274040910605918,
  5.5876517029280635,
  5.9199107633861505,
  6.271926975707988,
  6.644875161279123,
  7.04,
  7.458620184289437,
  7.902132820097988,
  8.372018089619155,
  8.869844191259906,
  9.397272573357045,
  9.95606347910659,
  10.548081821211836,
  11.175303405856127,
  11.839821526772301,
  12.543853951415976,
  13.289750322558247,
  14.08,
  14.917240368578874,
  15.804265640195975,
  16.74403617923831,
  17.739688382519812,
  18.79454514671409,
  19.91212695821318,
  21.096163642423672,
  22.350606811712254,
  23.679643053544602,
  25.08770790283195,
  26.579500645116493,
  28.16,
  29.834480737157772,
  31.608531280391933,
  33.48807235847662,
  35.47937676503964,
  37.58909029342816,
  39.82425391642636,
  42.19232728484737,
  44.701213623424486,
  47.359286107089204,
  50.17541580566394,
  53.15900129023296,
  56.32,
  59.668961474315545,
  63.217062560783866,
  66.97614471695324,
  70.95875353007928,
  75.17818058685631,
  79.64850783285272,
  84.38465456969475,
  89.40242724684897,
  94.71857221417841,
  100.35083161132788,
  106.31800258046592,
  112.64,
  119.33792294863109,
  126.43412512156773,
};

void spi_init() {
  //Enable SPI, Master, set clock rate fck/64 = 250kHz
  SPCR = (1<<SPE)|(1<<MSTR)|(1<<SPR1);
  SPSR = 0x00;
}

void trans_spi(char data) {
   //Start transmission
   SPDR = data;
   // Wait for transmission complete
   while(!(SPSR & (1<<SPIF)));
}

void output_dac_a(uint16_t data) {
  PORTB = (PORTB & ~LDAC_SS_MASK) | LDAC_MASK;
  trans_spi((data >> 8) | _BV(4) | _BV(5)); // OUT A, gain x1, no shutdown
  trans_spi(data & 0xFF);
  PORTB = (PORTB & ~LDAC_SS_MASK) | SS_MASK;
}

void output_dac_b(uint16_t data) {
  PORTB = (PORTB & ~LDAC_SS_MASK) | LDAC_MASK;
  trans_spi((data >> 8) | _BV(7) | _BV(4) | _BV(5)); // OUT B, gain x1, no shutdown
  trans_spi(data & 0xFF);
  PORTB = (PORTB & ~LDAC_SS_MASK) | SS_MASK;
}

//C0- B7 = 0 - 96
//A3(45) = 440
//1 timer count = 16kHz = 1/ 16000 s = 62.5us / 1 cycle
// ldac_pin = PB1
// ss_pin = PB0
void output_osc(uint16_t timer_count) {
  uint8_t wavetable_idx = 0; // TODO: select other wavetable!
  uint8_t current_table_index = (uint8_t)((uint16_t)(pitch_to_tableidx_x100[current_pitch]*timer_count/100.0)%256);
  uint16_t current_value = wavetables[wavetable_idx][current_table_index];
  output_dac_a(current_value*4);
}

void output_cv(uint16_t timer_count) {
  // current_pitch = 1 octave = 12 pitch unit
  // output 0-5V = 0-1024 spi val
  // 12 pitch unit = 0.5 V pin out
  // 120 pitch unit = 5 V pin out
  // 5 V pin out -> anlalog gain x2 -> 10V cv out
  output_dac_b(((uint16_t)current_pitch)*8);
}
