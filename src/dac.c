#include "dac.h"
#include "input.h"
#include "sequencer.h"
#include "wavetable.h"

// ピッチを1 tick(timer1) = (15.625us) あたりのtable index移動量として表現
// C1 - B8
static const float pitch_to_table_index[120] = {
  0.032703195662574826,
  0.03464782887210901,
  0.03670809598967595,
  0.038890872965260115,
  0.04120344461410874,
  0.04365352892912549,
  0.0462493028389543,
  0.04899942949771866,
  0.051913087197493143,
  0.055,
  0.05827047018976124,
  0.061735412657015515,
  0.06540639132514965,
  0.06929565774421802,
  0.0734161919793519,
  0.07778174593052023,
  0.08240688922821748,
  0.08730705785825098,
  0.0924986056779086,
  0.09799885899543732,
  0.10382617439498629,
  0.11,
  0.11654094037952248,
  0.123470825314031,
  0.1308127826502993,
  0.13859131548843603,
  0.14683238395870377,
  0.15556349186104046,
  0.164813778456435,
  0.17461411571650196,
  0.1849972113558172,
  0.19599771799087468,
  0.20765234878997257,
  0.22,
  0.23308188075904496,
  0.246941650628062,
  0.2616255653005986,
  0.27718263097687207,
  0.29366476791740753,
  0.3111269837220809,
  0.32962755691287,
  0.3492282314330039,
  0.3699944227116344,
  0.39199543598174935,
  0.41530469757994515,
  0.44,
  0.4661637615180898,
  0.49388330125612423,
  0.5232511306011972,
  0.5543652619537441,
  0.5873295358348153,
  0.6222539674441618,
  0.6592551138257398,
  0.6984564628660079,
  0.7399888454232688,
  0.7839908719634985,
  0.8306093951598904,
  0.88,
  0.9323275230361796,
  0.9877666025122485,
  1.0465022612023944,
  1.1087305239074883,
  1.1746590716696306,
  1.2445079348883237,
  1.3185102276514795,
  1.3969129257320159,
  1.4799776908465376,
  1.567981743926997,
  1.6612187903197808,
  1.76,
  1.8646550460723592,
  1.975533205024497,
  2.093004522404789,
  2.2174610478149765,
  2.349318143339261,
  2.4890158697766473,
  2.637020455302959,
  2.7938258514640317,
  2.9599553816930753,
  3.135963487853994,
  3.3224375806395616,
  3.52,
  3.7293100921447184,
  3.951066410048994,
  4.186009044809578,
  4.434922095629953,
  4.698636286678522,
  4.978031739553295,
  5.274040910605918,
  5.5876517029280635,
  5.9199107633861505,
  6.271926975707988,
  6.644875161279123,
  7.04,
  7.458620184289443,
  7.902132820097983,
  8.372018089619155,
  8.86984419125991,
  9.39727257335704,
  9.95606347910659,
  10.548081821211843,
  11.175303405856122,
  11.839821526772301,
  12.543853951415985,
  13.28975032255824,
  14.08,
  14.917240368578886,
  15.804265640195966,
  16.74403617923831,
  17.73968838251982,
  18.79454514671408,
  19.91212695821318,
  21.096163642423686,
  22.350606811712243,
  23.679643053544602,
  25.08770790283197,
  26.57950064511648,
  28.16,
  29.834480737157772,
  31.608531280391933
};

void spi_init() {
  //Enable SPI, Master, set clock rate fck/64 = 250kHz
  SPCR = (1<<SPE)|(1<<MSTR)|(1<<SPR1);
  SPSR = 0x00;
}

static inline uint8_t trans_spi(uint8_t data) {
  SPDR = data;
  loop_until_bit_is_set(SPSR, SPIF);
  data = SPDR;
  return(data);
}

void output_dac_a(uint16_t data) {
  PORTB = (PORTB & ~LDAC_SS_MASK) | LDAC_MASK;
  trans_spi(((data >> 8) & 0x0F) | _BV(4) | _BV(5)); // OUT A, gain x1, no shutdown
  trans_spi(data & 0xFF);
  PORTB = (PORTB & ~LDAC_SS_MASK) | SS_MASK;
}

void output_dac_b(uint16_t data) {
  PORTB = (PORTB & ~LDAC_SS_MASK) | LDAC_MASK;
  trans_spi(((data >> 8) & 0x0F) | _BV(7) | _BV(4) | _BV(5)); // OUT B, gain x1, no shutdown
  trans_spi(data & 0xFF);
  PORTB = (PORTB & ~LDAC_SS_MASK) | SS_MASK;
}

//C0- B9 = 0 - 119
//A5(69) = 440
//1 timer count = 16kHz = 1/ 16000 s = 62.5us / 1 cycle
// ldac_pin = PB1
// ss_pin = PB0
void output_osc(uint16_t timer_count) {
  uint8_t wavetable_idx = 0; // TODO: can select other wavetable!
  uint8_t current_table_index = (uint8_t)((uint16_t)(pitch_to_table_index[current_pitch]*timer_count/100.0)%256);
  uint16_t current_value = wavetables[wavetable_idx][current_table_index];
  output_dac_a(current_value*4);
}

void output_cv(uint16_t timer_count) {
  // current_pitch = 1 octave = 12 pitch unit
  // output 0-5V = 0-1024 spi val
  // 12 pitch unit = 0.5 V pin out
  // 120 pitch unit = 5 V pin out
  // 5 V pin out -> anlalog gain x2 -> 10V cv out
  output_dac_b(((uint16_t)current_pitch)*8);
}
